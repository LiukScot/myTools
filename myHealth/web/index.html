<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>myHealth CSV Importer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="/shared/base.css">
</head>

<body class="mh-app">
  <div class="container py-3">
    <header class="d-flex align-items-center gap-3 mb-3">
      <div class="d-inline-flex align-items-center gap-2 fs-3 fw-bold">
        <span class="heart">‚ù§</span>
        <span>myHealth</span>
      </div>
    </header>

    <div id="app-main" class="hidden">
      <div class="row g-3 mb-3">
        <div class="col-12">
          <div class="d-flex flex-wrap gap-3 align-content-start">
            <button class="btn btn-outline-primary mh-nav__btn active" data-target="dashboard">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 13h6V4H4v9zm10 7h6V4h-6v16z" />
            </svg>
            Dashboard
          </button>
            <button class="btn btn-outline-secondary mh-nav__btn" data-target="newlog">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 5h12v14H6z" />
              <path d="M9 3v4m6-4v4M8 10h8m-8 4h6" />
            </svg>
            Logs and new entries
          </button>
            <button class="btn btn-outline-secondary mh-nav__btn" data-target="chatbot">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M5 5h14v9a2 2 0 0 1-2 2H9l-4 3V7a2 2 0 0 1 2-2z" />
              <path d="M8 9h8m-8 4h5" />
            </svg>
            Chatbot
          </button>
            <button class="btn btn-outline-secondary mh-nav__btn" data-target="settings">
            <svg class="icon" width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8z" />
              <path
                d="M19.4 15a1.8 1.8 0 0 0 .26-2.44l-.76-1.12.18-1.34a1.8 1.8 0 0 0-1.56-2l-1.35-.16-.9-1.03a1.8 1.8 0 0 0-2.74 0l-.9 1.03-1.35.16a1.8 1.8 0 0 0-1.56 2l.18 1.34-.76 1.12A1.8 1.8 0 0 0 4.6 15l1.23.64.36 1.32a1.8 1.8 0 0 0 1.78 1.34h1.36l1.05.96a1.8 1.8 0 0 0 2.44 0l1.05-.96h1.36a1.8 1.8 0 0 0 1.78-1.34l.36-1.32 1.23-.64z" />
            </svg>
            Settings
          </button>
            <a class="btn btn-outline-secondary mh-nav__btn hidden" id="go-hub" href="/" aria-label="Back to hub">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M15 5l-7 7 7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span>Back to hub</span>
          </a>
            <button class="btn btn-outline-danger logout-btn hidden" id="auth-logout" type="button">Log out</button>
          </div>
        </div>
      </div>

      <section id="dashboard-section">
        <div class="card" id="dashboard-stats">
          <h2>Dashboard</h2>
          <div class="mh-hint">Overview of diary and pain logs.</div>
          <div class="filters">
            <label>From
              <input type="date" id="filter-from" />
            </label>
            <label>To
              <input type="date" id="filter-to" />
            </label>
            <div class="divider"></div>
            <div class="mh-quick-filters">
              <button class="mh-quick-btn" data-range="7">1 week</button>
              <button class="mh-quick-btn" data-range="30">1 month</button>
              <button class="mh-quick-btn" data-range="90">3 months</button>
              <button class="mh-quick-btn" data-range="180">6 months</button>
              <button class="mh-quick-btn" data-range="365">1 year</button>
              <button class="mh-quick-btn" data-range="1095">3 years</button>
              <button class="mh-quick-btn" data-range="all">Since start</button>
            </div>
          </div>
          <div class="dash-grid" id="dash-cards"></div>
        </div>
        <div class="graph-grid" id="dash-graphs"></div>
      </section>

      <section id="newlog-section" class="hidden">
        <div class="card">
          <h2>New Entry</h2>
          <div class="mh-hint">Capture a quick log without waiting for a CSV import.</div>
          <div class="mh-entry-tabs" role="tablist" aria-label="New entry categories">
            <button class="mh-entry-btn active" data-entry="pain" type="button">Physical pain</button>
            <button class="mh-entry-btn" id="autotherapy-tab" data-entry="autotherapy" type="button">Autotherapy
              ‚óÄ</button>
          </div>

          <div class="entry-panel" data-entry-panel="pain">
            <form id="pain-form">
              <div class="form-grid pain-grid">
                <div class="form-group">
                  <label for="pain-date">Entry Date/Time</label>
                  <input id="pain-date" name="pain-date" type="datetime-local" />
                  <small>Stored as separate date + time columns; defaults to now if left empty.</small>
                </div>
                <div class="form-group">
                  <label for="pain-level">Pain Level (1-9)</label>
                  <input id="pain-level" name="pain-level" type="number" min="1" max="9" step="1"
                    placeholder="e.g. 6" />
                </div>
                <div class="form-group">
                  <label for="fatigue-level">Fatigue Level (1-9)</label>
                  <input id="fatigue-level" name="fatigue-level" type="number" min="1" max="9" step="1"
                    placeholder="e.g. 4" />
                </div>
                <div class="form-group small-field">
                  <label for="coffee-count">Coffee (cups)</label>
                  <input id="coffee-count" name="coffee-count" type="number" min="0" max="9" step="1"
                    placeholder="e.g. 1" />
                </div>
                <div class="form-group chip-group">
                  <label>Area <button type="button" class="chip-edit" data-edit="area">Edit</button></label>
                  <div id="area-options" class="chip-row" data-field="area"></div>
                  <div id="area-editor" class="chip-editor hidden" data-field="area"></div>
                </div>
                <div class="form-group chip-group">
                  <label>Symptoms <button type="button" class="chip-edit" data-edit="symptoms">Edit</button></label>
                  <div id="symptoms-options" class="chip-row" data-field="symptoms"></div>
                  <div id="symptoms-editor" class="chip-editor hidden" data-field="symptoms"></div>
                </div>
                <div class="form-group chip-group">
                  <label>Activities <button type="button" class="chip-edit" data-edit="activities">Edit</button></label>
                  <div id="activities-options" class="chip-row" data-field="activities"></div>
                  <div id="activities-editor" class="chip-editor hidden" data-field="activities"></div>
                </div>
                <div class="form-group chip-group">
                  <label>Medicines <button type="button" class="chip-edit" data-edit="medicines">Edit</button></label>
                  <div id="medicines-options" class="chip-row" data-field="medicines" data-preselect="all"></div>
                  <div id="medicines-editor" class="chip-editor hidden" data-field="medicines"></div>
                </div>
                <div class="form-group chip-group">
                  <label>Habits <button type="button" class="chip-edit" data-edit="habits">Edit</button></label>
                  <div id="habits-options" class="chip-row" data-field="habits"></div>
                  <div id="habits-editor" class="chip-editor hidden" data-field="habits"></div>
                </div>
                <div class="form-group chip-group">
                  <label>Other <button type="button" class="chip-edit" data-edit="other">Edit</button></label>
                  <div id="other-options" class="chip-row" data-field="other"></div>
                  <div id="other-editor" class="chip-editor hidden" data-field="other"></div>
                </div>
                <div class="form-group notes-group">
                  <label for="pain-note">Notes</label>
                  <textarea id="pain-note" name="pain-note" placeholder="Anything else worth tracking?"></textarea>
                </div>
              </div>
              <div class="form-actions">
        <button class="mh-btn-primary mh-btn-plain" id="pain-submit-btn" type="submit">Save new entry</button>
                <button class="mh-btn-muted hidden" id="pain-cancel-btn" type="button">Cancel edit</button>
                <div id="pain-form-status" class="mh-status"></div>
              </div>
            </form>
            <div class="form-divider"></div>
            <div class="card">
              <div class="log-header">
                <h2>Pain log <span id="pain-count" style="color:var(--muted); font-size:14px; margin-left:8px;"></span>
                </h2>
              </div>
              <div class="list-wrap" id="pain-table"></div>
            </div>
          </div>

          <div class="entry-panel hidden" data-entry-panel="autotherapy">
            <div id="autotherapy-stack">
              <div class="entry-tabs autotherapy-subnav mh-entry-tabs" role="tablist" aria-label="Autotherapy entries">
                <button class="mh-entry-btn secondary" data-autotherapy="journal" type="button">Journal</button>
                <button class="mh-entry-btn secondary" data-autotherapy="cbt" type="button">CBT thought
                  response</button>
                <button class="mh-entry-btn secondary" data-autotherapy="dbt" type="button">DBT distress
                  tolerance</button>
              </div>
              <div class="entry-panel hidden" data-autotherapy-panel="journal">
                <form id="journal-form">
                  <div class="form-grid pain-grid">
                    <div class="form-group">
                      <label for="journal-date">Entry date/time</label>
                      <input id="journal-date" name="journal-date" type="datetime-local" />
                      <small>Stored as separate date + time columns; defaults to now if left empty.</small>
                    </div>
                    <div class="form-group">
                      <label for="journal-mood">Mood level (1-9)</label>
                      <input id="journal-mood" name="journal-mood" type="number" min="1" max="9" step="1"
                        placeholder="e.g. 6" />
                    </div>
                    <div class="form-group">
                      <label for="journal-depression">Depression (1-9)</label>
                      <input id="journal-depression" name="journal-depression" type="number" min="1" max="9" step="1"
                        placeholder="e.g. 4" />
                    </div>
                    <div class="form-group">
                      <label for="journal-anxiety">Anxiety (1-9)</label>
                      <input id="journal-anxiety" name="journal-anxiety" type="number" min="1" max="9" step="1"
                        placeholder="e.g. 5" />
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label for="journal-description">description</label>
                      <textarea id="journal-description" name="journal-description"
                        placeholder="cosa hai fatto oggi?"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label for="journal-gratitude">gratitude</label>
                      <textarea id="journal-gratitude" name="journal-gratitude"
                        placeholder="per cosa sei grato?"></textarea>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                      <label for="journal-reflection">reflection</label>
                      <textarea id="journal-reflection" name="journal-reflection"
                        placeholder="vuoi riflettere su qualcosa?"></textarea>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button class="mh-btn-primary mh-btn-plain" id="journal-submit-btn" type="submit">Save journal
                      entry</button>
                    <button class="mh-btn-muted hidden" id="journal-cancel-btn" type="button">Cancel edit</button>
                    <div id="journal-form-status" class="mh-status"></div>
                  </div>
                </form>
                <div class="form-divider"></div>
                <div class="card">
                  <div class="log-header">
                    <h2>Journal log <span id="diary-count"
                        style="color:var(--muted); font-size:14px; margin-left:8px;"></span></h2>
                  </div>
                  <div class="list-wrap" id="diary-table"></div>
                </div>
              </div>
              <div class="entry-panel hidden" data-autotherapy-panel="cbt">
                <div class="mh-hint">CBT thought response coming soon.</div>
              </div>
              <div class="entry-panel hidden" data-autotherapy-panel="dbt">
                <div class="mh-hint">DBT distress tolerance coming soon.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="chatbot-section" class="hidden">
        <div class="card">
          <h2>Chatbot</h2>
          <div class="mh-hint">Ask the assistant about your diary and pain logs. Configure your Mistral key in
            Settings.</div>

          <div class="stacked-fields" style="gap: 15px;">
            <div class="field-group">
              <label for="chatbot-prompt"><strong>Message</strong></label>
              <div class="mh-hint" id="chatbot-helper">Save a Mistral key in Settings to enable sending.</div>
          <div class="chat-range" aria-label="Chat context range">
            <span class="sub-label">How many days should the model read?</span>
            <div class="mh-quick-filters">
              <button class="mh-quick-btn chat-range-btn" data-range="30">1 month</button>
              <button class="mh-quick-btn chat-range-btn" data-range="90">3 months</button>
              <button class="mh-quick-btn chat-range-btn" data-range="365">1 year</button>
              <button class="mh-quick-btn chat-range-btn" data-range="all">Since start</button>
            </div>
          </div>
              <div class="chat-input-row constrained">
                <textarea id="chatbot-prompt" class="inline-input multiline" rows="3"
                  placeholder="Ask about your trends, e.g. \" Summarize my pain this week\""></textarea>
                <button class="mh-btn-primary mh-btn-plain" id="chatbot-send-btn" type="button" disabled>Send</button>
              </div>
              <div class="mh-status" id="chatbot-status"></div>
            </div>

            <div class="field-group">
              <div class="chat-loading hidden" id="chatbot-loading">
                <div class="spinner" aria-hidden="true"></div>
                <span>Generating...</span>
              </div>
              <div class="chat-log" id="chatbot-log">
              <div class="mh-hint">No messages yet. The assistant will answer here once connected.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="settings-section" class="hidden">
        <div class="card">
          <h2>Settings</h2>
          <div class="mh-hint">Import/export your data and manage the chatbot connection.</div>

          <div class="stacked-fields settings-grid">
            <!-- JSON import/export -->
            <div class="mh-field-group mh-group-box">
              <label><strong>Import from JSON</strong></label>
              <div class="mh-inline-row">
                <input type="file" id="import-backup-input" accept=".json" />
                <button class="mh-nav__btn" id="export-backup-button">Export JSON</button>
              </div>
            </div>

            <!-- XLSX import/export -->
            <div class="mh-field-group mh-group-box">
              <label><strong>Import from XLSX</strong> <span class="hint-inline">(sheets: <code>diary</code>,
                  <code>pain</code>)</span></label>
              <div class="mh-inline-row">
                <input type="file" id="import-xlsx-input" accept=".xlsx,.xls" />
                <button class="mh-nav__btn" id="export-xlsx-button">Export XLSX</button>
              </div>
            </div>

            <h3>Chatbot</h3>

            <div class="mh-field-group mh-group-box">
              <label for="mistral-api-key"><strong>Mistral API key</strong></label>
              <div class="hint" id="mistral-key-helper">Key is stored server-side for your account and never shown back.
                Only the chat prompt and selected log context are sent to Mistral (EU-based) when you ask a question.
              </div>
              <div class="settings-inline">
                <input class="inline-input long" type="password" id="mistral-api-key"
                  placeholder="Paste your Mistral API key" autocomplete="off" />
                <button class="mh-nav__btn" id="save-mistral-key" type="button">Save key</button>
                <button class="mh-nav__btn" id="clear-mistral-key" type="button">Clear</button>
              </div>
              <div class="mh-status" id="mistral-key-status"></div>
            </div>

            <div class="mh-field-group mh-group-box">
              <label for="mistral-model"><strong>Mistral model</strong></label>
              <div class="hint">Pick a balance of speed, cost, and quality. Small is the fastest default; Large gives the most detail.
              </div>
              <div class="settings-inline">
                <select class="inline-input long" id="mistral-model">
                  <option value="mistral-small-latest" selected>mistral-small-latest (fast, default)</option>
                  <option value="mistral-medium-latest">mistral-medium-latest (balanced)</option>
                  <option value="mistral-large-latest">mistral-large-latest (highest quality)</option>
                </select>
              </div>
            </div>

            <h3>Danger zone</h3>
            <div class="danger-zone">
              <button class="mh-nav__btn danger" id="full-purge-button">üß® delete all data</button>
            </div>
          </div>
        </div>

        <div class="mh-status" id="backup-status"></div>
        <pre class="error-box hidden" id="backup-error"></pre>

        <!-- hidden status nodes to satisfy existing refs -->
        <div class="mh-status hidden" id="diary-status-import"></div>
        <div class="mh-status hidden" id="pain-status-import"></div>
      </section>
    </div>
  </div>

  <script type="module" src="/myhealth/js/app.js"></script>

</body>

</html>
