name: Deploy myHealth (FTP)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'myHealth/**'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Deploy to Hetzner via FTP
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          REMOTE_BASE: ${{ secrets.REMOTE_BASE }}
        run: |
          set -euo pipefail
          : "${FTP_HOST:?FTP_HOST secret missing}"
          : "${FTP_USER:?FTP_USER secret missing}"
          : "${FTP_PASS:?FTP_PASS secret missing}"
          REMOTE_BASE="${REMOTE_BASE:-/public_html/myhealth}"
          LOCAL_DIR="$(realpath myHealth/web)"
          if [[ ! -d "$LOCAL_DIR" ]]; then
            echo "Local dir not found: $LOCAL_DIR" >&2
            exit 1
          fi
          echo "Deploying $LOCAL_DIR -> $REMOTE_BASE on $FTP_HOST as $FTP_USER"
          lftp -u "$FTP_USER","$FTP_PASS" sftp://"$FTP_HOST" -e "set ssl:verify-certificate no; set sftp:auto-confirm yes; mirror -R --delete --verbose --parallel=4 --exclude-glob .DS_Store --include-glob .htaccess \"$LOCAL_DIR\" \"$REMOTE_BASE\"; bye"
